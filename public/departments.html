<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Departamentos - BHS</title>
<style>
  :root{--green:#25D366}
  *{box-sizing:border-box}
  body{font-family:Segoe UI,Arial,sans-serif;background:#f5f5f5;margin:0;padding:20px}
  .container{max-width:960px;margin:auto;background:#fff;border-radius:14px;padding:24px;box-shadow:0 6px 20px rgba(0,0,0,.08)}
  .topbar{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  .back{appearance:none;border:0;background:#eee;color:#111;border-radius:10px;padding:8px 12px;cursor:pointer}
  h1{margin:6px 0 16px}
  .hint{color:#666;margin-bottom:18px}
  .list{list-style:none;margin:0;padding:0}
  .item{display:flex;align-items:center;justify-content:space-between;background:#fafafa;border:1px solid #eee;border-radius:12px;padding:12px 14px;margin-bottom:8px;cursor:grab}
  .item.drag{opacity:.5}
  .controls button{margin-left:8px}
  .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
  .btn.primary{background:var(--green);color:#fff}
  .btn.ghost{background:#f1f1f1;color:#111}
  .grid{display:grid;grid-template-columns:1fr 1fr 1fr 1fr auto;gap:8px;margin-top:16px}
  input,select{padding:10px;border:1px solid #ddd;border-radius:10px}
  .row{display:flex;gap:8px;align-items:center;margin-top:12px}
  .tag{display:inline-block;background:#eafaf0;color:#1c7a3e;border:1px solid #ccefd8;border-radius:999px;padding:2px 8px;font-size:12px;margin-left:8px}
</style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <button class="back" onclick="location.href='/admin'">‚¨ÖÔ∏è Voltar</button>
      <h1>üì± Departamentos <span class="tag">arraste para reordenar</span></h1>
    </div>
    <p class="hint">Use o formato <b>5511999999999</b> para telefone (c√≥digo do pa√≠s + DDD + n√∫mero, sem espa√ßos).</p>

    <ul id="list" class="list"></ul>

    <h3 style="margin-top:20px">Adicionar novo</h3>
    <div class="grid">
      <input id="name" placeholder="Nome *">
      <input id="phone" placeholder="Telefone (opcional)">
      <input id="emoji" placeholder="Emoji" value="üìû">
      <select id="type">
        <option value="whatsapp">WhatsApp</option>
        <option value="ai">IA</option>
      </select>
      <button class="btn primary" id="add">Adicionar</button>
    </div>

    <div class="row">
      <button class="btn ghost" id="reload">Recarregar</button>
      <button class="btn primary" id="saveOrder">Salvar ordem</button>
    </div>
  </div>

<script>
let data=[];
const list=document.getElementById('list');
const nameEl=document.getElementById('name');
const phoneEl=document.getElementById('phone');
const emojiEl=document.getElementById('emoji');
const typeEl=document.getElementById('type');

async function load(){
  const r=await fetch('/api/departments');
  data=await r.json();
  render();
}

function render(){
  list.innerHTML='';
  data.forEach(d=>{
    const li=document.createElement('li');
    li.className='item';
    li.draggable=true;
    li.dataset.id=d.id;
    li.innerHTML=`
      <span>${d.emoji} <b>${d.name}</b> <small style="color:#666">${d.phone||'-'}</small> <i style="color:#777">(${d.type})</i></span>
      <span class="controls">
        <button class="btn ghost" onclick="editItem(${d.id})">Editar</button>
        <button class="btn ghost" onclick="delItem(${d.id})">Excluir</button>
      </span>
    `;
    li.addEventListener('dragstart',()=>li.classList.add('drag'));
    li.addEventListener('dragend',()=>li.classList.remove('drag'));
    list.appendChild(li);
  });
}

list.addEventListener('dragover',e=>{
  e.preventDefault();
  const dragging=document.querySelector('.item.drag');
  if(!dragging) return;
  const siblings=[...list.querySelectorAll('.item:not(.drag)')];
  const next=siblings.find(s=>e.clientY<=s.getBoundingClientRect().top + s.offsetHeight/2);
  list.insertBefore(dragging,next||null);
});

document.getElementById('saveOrder').onclick=async()=>{
  const order=[...list.children].map(li=>parseInt(li.dataset.id));
  await fetch('/api/departments/order',{
    method:'PUT',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({order})
  });
  alert('Ordem salva!');
  await load();
};

document.getElementById('add').onclick=async()=>{
  const payload={
    name: nameEl.value.trim(),
    phone: phoneEl.value.trim(),
    emoji: emojiEl.value.trim() || 'üìû',
    type: typeEl.value
  };
  if(!payload.name){ alert('Nome √© obrigat√≥rio'); return; }
  await fetch('/api/departments',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  nameEl.value=''; phoneEl.value=''; emojiEl.value='üìû'; typeEl.value='whatsapp';
  await load();
};

document.getElementById('reload').onclick=load;

window.editItem=async(id)=>{
  const d=data.find(x=>x.id===id);
  if(!d) return;
  const name=prompt('Nome:', d.name) ?? d.name;
  const phone=prompt('Telefone:', d.phone ?? '') ?? d.phone;
  const emoji=prompt('Emoji:', d.emoji) ?? d.emoji;
  const type=prompt('Tipo (whatsapp/ai):', d.type) ?? d.type;
  await fetch('/api/departments/'+id,{
    method:'PUT',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({name,phone,emoji,type})
  });
  await load();
};

window.delItem=async(id)=>{
  if(!confirm('Excluir este departamento?')) return;
  await fetch('/api/departments/'+id,{ method:'DELETE' });
  await load();
};

load();
</script>
</body>
</html>

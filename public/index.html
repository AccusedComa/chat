<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Widget BHS</title>
<style>
body{font-family:Arial,Helvetica,sans-serif;margin:0}
#chat-btn{position:fixed;right:20px;bottom:20px;width:64px;height:64px;border-radius:50%;background:#25D366;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 24px rgba(0,0,0,.25);cursor:pointer;z-index:1000}
#chat-btn:hover{transform:scale(1.05)} #chat-btn svg{width:34px;height:34px;fill:#fff}
#badge{position:absolute;top:-4px;right:-4px;background:#ff3b30;color:#fff;border-radius:999px;font-size:12px;line-height:18px;min-width:18px;height:18px;display:flex;align-items:center;justify-content:center;border:2px solid #fff;font-weight:bold;animation:pulse 1.8s infinite}
@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.15)}100%{transform:scale(1)}}
#chat{position:fixed;right:20px;bottom:92px;width:360px;max-width:calc(100% - 24px);height:520px;background:#fff;border-radius:16px;box-shadow:0 18px 60px rgba(0,0,0,.25);display:none;flex-direction:column;overflow:hidden;z-index:999}
#header{background:#25D366;color:#fff;padding:12px 14px;display:flex;align-items:center;justify-content:space-between}
#header .title{font-weight:bold} #close{background:transparent;border:0;color:#fff;font-size:22px;cursor:pointer}
#msgs{flex:1;overflow:auto;background:#e5ddd5;padding:10px;display:flex;flex-direction:column}
.msg{margin:6px 0;padding:10px 14px;border-radius:10px;max-width:80%;word-wrap:break-word}
.user{background:#dcf8c6;align-self:flex-end} .bot{background:#fff;border:1px solid #ddd;align-self:flex-start}
#options{padding:10px;border-top:1px solid #eee;display:grid;grid-template-columns:1fr 1fr;gap:8px}
.opt{background:#f7f7f7;border:1px solid #eee;border-radius:10px;padding:10px;cursor:pointer;text-align:left}
.opt:hover{background:#fff}
#input{display:flex;border-top:1px solid #ddd} #text{flex:1;padding:12px;border:0;outline:none} #send{background:#25D366;color:#fff;border:0;padding:0 16px;cursor:pointer}
.small{font-size:12px;color:#666}
</style>
</head>
<body>
<div id="chat-btn" title="Fale conosco">
  <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <path d="M16 2C8.268 2 2 8.268 2 16c0 2.64.74 5.11 2.02 7.24L2 30l6.93-1.99C10.88 29 13.36 30 16 30c7.732 0 14-6.268 14-14S23.732 2 16 2zM9.74 8.82a1.2 1.2 0 0 0-1.2 1.2c0 .66-.16 1.79.35 3.02.51 1.23 1.78 3.2 4.18 5.09 2.4 1.89 4.21 2.46 5.02 2.64.81.18 1.54.16 2.02.1.48-.06 1.53-.62 1.76-1.27.23-.65.23-1.2.16-1.32-.07-.12-.25-.18-.52-.32-.27-.14-1.61-.79-1.86-.88-.25-.09-.43-.14-.62.14-.18.28-.71.91-.87 1.09-.16.18-.31.21-.58.07-.27-.14-1.14-.42-2.17-1.34-1.37-1.22-2.25-2.7-2.39-2.99-.14-.28-.02-.45.11-.59.12-.13.27-.3.4-.45.13-.15.17-.27.25-.45.08-.18.04-.34-.02-.47-.06-.13-.61-1.46-.84-2-.22-.55-.44-.47-.61-.48l-.52-.01z"/>
  </svg>
  <span id="badge">1</span>
</div>

<div id="chat">
  <div id="header"><span class="title">BHS Eletr√¥nica</span><button id="close" aria-label="Fechar">&times;</button></div>
  <div id="msgs"></div>
  <div id="options"></div>
  <div id="input"><input id="text" type="text" placeholder="Digite sua mensagem..." autocomplete="off"><button id="send">Enviar</button></div>
</div>

<script>
const btn=document.getElementById('chat-btn'),
      chat=document.getElementById('chat'),
      badge=document.getElementById('badge'),
      closeBtn=document.getElementById('close'),
      msgs=document.getElementById('msgs'),
      options=document.getElementById('options'),
      text=document.getElementById('text'),
      send=document.getElementById('send');

const sessionId=Math.random().toString(36).slice(2,10);

// =========== Fun√ß√µes ===========
function addMsg(content,who='bot'){
  const d=document.createElement('div');
  d.className='msg '+who;
  d.innerHTML=content.replace(/\n/g, '<br>'); // quebra de linha
  msgs.appendChild(d);
  msgs.scrollTop=msgs.scrollHeight;
}

// Mostra ‚ÄúDigitando...‚Äù
function showTyping(){
  const typing=document.createElement('div');
  typing.className='msg bot typing';
  typing.innerHTML='<i>Digitando...</i>';
  msgs.appendChild(typing);
  msgs.scrollTop=msgs.scrollHeight;
  return typing;
}

function setInitialMenu(deps){
  options.innerHTML='';
  deps.forEach(d=>{
    const b=document.createElement('button');
    b.className='opt';
    b.innerHTML=`${d.emoji} <b>${d.name}</b><br><span class="small">${d.type==='ai'?'Chat com IA':'WhatsApp'}</span>`;
    b.onclick=()=>{
      if(d.type==='ai'){
        addMsg('Voc√™ est√° falando com a IA ü§ñ.');
      } else if(d.phone){
        window.open('https://wa.me/'+d.phone,'_blank');
      }
    };
    options.appendChild(b);
  });
}

async function loadMenu(){
  const r=await fetch('/api/departments');
  const deps=await r.json();
  setInitialMenu(deps);
  addMsg('Ol√°! üëã Escolha uma op√ß√£o abaixo ou mande sua pergunta para a IA.');
}

// Envia para IA
async function sendToAI(message){
  const r=await fetch('/api/chat',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({message,sessionId})
  });
  const data=await r.json();
  return data.message;
}

// =========== Eventos ===========
btn.addEventListener('click',()=>{
  const show=chat.style.display!=='flex';
  chat.style.display=show?'flex':'none';
  if(show){
    badge.style.display='none';
    if(!options.children.length) loadMenu();
  }
});

closeBtn.addEventListener('click',()=>chat.style.display='none');

send.addEventListener('click',async()=>{
  const m=text.value.trim();
  if(!m) return;
  addMsg(m,'user');
  text.value='';

  // remove bot√µes ap√≥s primeira intera√ß√£o
  if(options.style.display!=='none'){
    options.style.display='none';
  }

  const typingEl=showTyping();
  try{
    const reply=await sendToAI(m);
    typingEl.remove();
    addMsg(reply,'bot');
  }catch{
    typingEl.remove();
    addMsg('Erro ao conectar com a IA. Tente novamente.','bot');
  }
});

text.addEventListener('keypress',e=>{
  if(e.key==='Enter') send.click();
});
</script>
</body>
</html>
